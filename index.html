<!doctype html>
<html lang="ja">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KAWACut Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .part-item {
            transition: all 0.2s ease;
        }
        .part-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .cutting-diagram {
            background-image: 
                linear-gradient(rgba(0,0,0,.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-full">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
   <div class="text-center mb-8">
    <h1 class="text-4xl font-bold text-gray-800 mb-2">KAWACut Studio ver.5.0</h1>
    <p class="text-gray-600">éƒ¨å“è¡¨ã¨ææ–™ã‚µã‚¤ã‚ºã‹ã‚‰åŠ¹ç‡çš„ãªæœ¨å–å›³ã‚’è‡ªå‹•ç”Ÿæˆ</p>
   </div>
   <div class="grid lg:grid-cols-2 gap-8"><!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
    <div class="space-y-6"><!-- ææ–™ã‚µã‚¤ã‚ºå…¥åŠ› -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">ğŸ“ ææ–™ã‚µã‚¤ã‚ºãƒ»åˆ‡ã‚Šã—ã‚è¨­å®š</h2><!-- ææ–™1 -->
      <div class="mb-4">
       <h3 class="text-lg font-medium text-gray-700 mb-3">ææ–™1</h3>
       <div class="grid grid-cols-3 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">é•·ã• (mm)</label> <input type="number" id="materialLength1" value="1200" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">å¹… (mm)</label> <input type="number" id="materialWidth1" value="160" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">ä½¿ç”¨å¯èƒ½æšæ•°</label> <select id="materialCount1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="1" selected>1æš</option> <option value="2">2æš</option> <option value="3">3æš</option> <option value="4">4æš</option> <option value="5">5æš</option> <option value="6">6æš</option> <option value="7">7æš</option> <option value="8">8æš</option> <option value="9">9æš</option> <option value="10">10æš</option> </select>
        </div>
       </div>
      </div><!-- ææ–™2 -->
      <div class="mb-4">
       <h3 class="text-lg font-medium text-gray-700 mb-3">ææ–™2ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</h3>
       <div class="grid grid-cols-3 gap-4">
        <div><label class="block text-sm font-medium text-gray-700 mb-2">é•·ã• (mm)</label> <input type="number" id="materialLength2" placeholder="æœªä½¿ç”¨ã®å ´åˆã¯ç©ºæ¬„" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">å¹… (mm)</label> <input type="number" id="materialWidth2" placeholder="æœªä½¿ç”¨ã®å ´åˆã¯ç©ºæ¬„" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label class="block text-sm font-medium text-gray-700 mb-2">ä½¿ç”¨å¯èƒ½æšæ•°</label> <select id="materialCount2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="1" selected>1æš</option> <option value="2">2æš</option> <option value="3">3æš</option> <option value="4">4æš</option> <option value="5">5æš</option> <option value="6">6æš</option> <option value="7">7æš</option> <option value="8">8æš</option> <option value="9">9æš</option> <option value="10">10æš</option> </select>
        </div>
       </div>
      </div><!-- åˆ‡ã‚Šã—ã‚è¨­å®š -->
      <div class="mb-4">
       <h3 class="text-lg font-medium text-gray-700 mb-3">åˆ‡ã‚Šã—ã‚è¨­å®šï¼ˆå…±é€šï¼‰</h3>
       <div class="w-full max-w-xs"><select id="cuttingMargin" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="0">0mm</option> <option value="1">1mm</option> <option value="2">2mm</option> <option value="3">3mm</option> <option value="4">4mm</option> <option value="5">5mm</option> <option value="6" selected>6mm</option> <option value="7">7mm</option> <option value="8">8mm</option> <option value="9">9mm</option> <option value="10">10mm</option> </select>
       </div>
      </div>
      <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded-lg">
       ğŸ’¡ ææ–™2ã¯å¿…è¦ã«å¿œã˜ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚åˆ‡ã‚Šã—ã‚ã¯ä¸¡æ–¹ã®ææ–™ã«å…±é€šã§é©ç”¨ã•ã‚Œã¾ã™ã€‚
      </div>
     </div><!-- éƒ¨å“è¿½åŠ  -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">â• éƒ¨å“è¿½åŠ </h2>
      <div class="grid grid-cols-4 gap-3 mb-4">
       <div><label class="block text-xs font-medium text-gray-700 mb-1">éƒ¨å“å</label> <input type="text" id="partName" placeholder="å¤©æ¿" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-xs font-medium text-gray-700 mb-1">é•·ã• (mm)</label> <input type="number" id="partLength" placeholder="800" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-xs font-medium text-gray-700 mb-1">å¹… (mm)</label> <input type="number" id="partWidth" placeholder="400" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
       </div>
       <div><label class="block text-xs font-medium text-gray-700 mb-1">æ•°é‡</label> <input type="number" id="partQuantity" value="1" min="1" class="w-full px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
       </div>
      </div><button onclick="addPart()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"> éƒ¨å“ã‚’è¿½åŠ  </button>
     </div><!-- éƒ¨å“ãƒªã‚¹ãƒˆ -->
     <div class="bg-white rounded-xl shadow-lg p-6">
      <div class="flex justify-between items-center mb-4">
       <h2 class="text-xl font-semibold text-gray-800 flex items-center">ğŸ“‹ éƒ¨å“è¡¨</h2>
       <div class="flex gap-2"><button onclick="generateCuttingDiagram()" class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"> æœ¨å–å›³ç”Ÿæˆ </button> <button onclick="exportProject()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"> ğŸ’¾ ä¿å­˜ </button> <button onclick="document.getElementById('importFile').click()" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition-colors"> ğŸ“‚ é–‹ã </button> <input type="file" id="importFile" accept=".woodcut" style="display: none;" onchange="importProject(event)">
       </div>
      </div>
      <div id="partsList" class="space-y-2"><!-- éƒ¨å“ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>
     </div>
    </div><!-- æœ¨å–å›³è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="bg-white rounded-xl shadow-lg p-6">
     <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold text-gray-800 flex items-center">ğŸ¯ ææ–™å–å›³ï¼ˆæœ¨å–å›³ï¼‰</h2><button id="saveImageBtn" onclick="saveAsImage()" class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed" disabled> ğŸ“· JPGä¿å­˜ </button>
     </div><!-- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆé¸æŠ -->
     <div id="colorPaletteSection" class="mb-4 hidden">
      <h3 class="text-sm font-medium text-gray-700 mb-2">ğŸ¨ éƒ¨å“ã®è‰²ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º:</h3>
      <p class="text-xs text-gray-600 mb-3">å„éƒ¨å“ã®è‰²ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å¤‰æ›´ã§ãã¾ã™ã€‚æœ¨å–å›³ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
      <div class="flex flex-wrap gap-3" id="colorPalette"><!-- ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>
     </div><!-- åå‰å…¥åŠ›æ¬„ -->
     <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">ä½œæˆè€…åï¼ˆJPGä¿å­˜æ™‚ã«è¡¨ç¤ºï¼‰:</label> <input type="text" id="creatorName" placeholder="å·ä¸Šç¿”å¹³" class="w-full max-w-xs px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
     </div><!-- æœ¨å–å›³ -->
     <div id="cuttingDiagramContainer" class="border-2 border-dashed border-gray-300 rounded-lg p-4 min-h-96">
      <div class="text-center text-gray-500 mt-20">
       <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" viewbox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
       </svg>
       <p>éƒ¨å“ã‚’è¿½åŠ ã—ã¦ã€Œæœ¨å–å›³ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
      </div>
     </div>
     <div id="materialUsage" class="mt-4 text-sm text-gray-600"></div>
    </div>
   </div>
  </div>
  <script>
        let parts = [];
        let partIdCounter = 1;
        let currentColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F', '#FF8A80', '#80CBC4', '#81C784', '#FFB74D', '#F48FB1', '#CE93D8', '#90CAF9', '#A5D6A7'];
        let partTypeColors = {};

        function addPart() {
            const name = document.getElementById('partName').value.trim();
            const length = parseInt(document.getElementById('partLength').value);
            const width = parseInt(document.getElementById('partWidth').value);
            const quantity = parseInt(document.getElementById('partQuantity').value);

            if (!name || !length || !width || !quantity) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            for (let i = 0; i < quantity; i++) {
                parts.push({
                    id: partIdCounter++,
                    name: quantity > 1 ? `${name} (${i + 1})` : name,
                    length: length,
                    width: width,
                    originalName: name,
                    placed: false
                });
            }

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('partName').value = '';
            document.getElementById('partLength').value = '';
            document.getElementById('partWidth').value = '';
            document.getElementById('partQuantity').value = '1';

            updatePartsList();
        }

        function updatePartsList() {
            const partsList = document.getElementById('partsList');
            if (parts.length === 0) {
                partsList.innerHTML = '<p class="text-gray-500 text-center py-4">éƒ¨å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>';
                return;
            }

            partsList.innerHTML = parts.map(part => `
                <div class="part-item flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1">
                        <span class="font-medium text-gray-800">${part.name}</span>
                        <span class="text-sm text-gray-600 ml-2">${part.length} Ã— ${part.width} mm</span>
                    </div>
                    <button onclick="removePart(${part.id})" 
                            class="text-red-500 hover:text-red-700 p-1 rounded">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function removePart(id) {
            parts = parts.filter(part => part.id !== id);
            updatePartsList();
        }

        function generateCuttingDiagram() {
            if (parts.length === 0) {
                alert('éƒ¨å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
                return;
            }

            // ææ–™ã‚µã‚¤ã‚ºã¨ä½¿ç”¨å¯èƒ½æšæ•°ã‚’å–å¾—
            const materialLength1 = parseInt(document.getElementById('materialLength1').value);
            const materialWidth1 = parseInt(document.getElementById('materialWidth1').value);
            const materialCount1 = parseInt(document.getElementById('materialCount1').value);
            const materialLength2 = parseInt(document.getElementById('materialLength2').value) || null;
            const materialWidth2 = parseInt(document.getElementById('materialWidth2').value) || null;
            const materialCount2 = parseInt(document.getElementById('materialCount2').value) || 0;
            const cuttingMargin = parseInt(document.getElementById('cuttingMargin').value);

            // åˆ©ç”¨å¯èƒ½ãªææ–™ã‚¿ã‚¤ãƒ—ã‚’å®šç¾©ï¼ˆä½¿ç”¨å¯èƒ½æšæ•°ã‚‚å«ã‚€ï¼‰
            const materialTypes = [
                { length: materialLength1, width: materialWidth1, type: 1, maxCount: materialCount1, usedCount: 0 }
            ];
            
            if (materialLength2 && materialWidth2) {
                materialTypes.push({ length: materialLength2, width: materialWidth2, type: 2, maxCount: materialCount2, usedCount: 0 });
            }

            // éƒ¨å“ã‚’é•·ã•å„ªå…ˆã§ã‚½ãƒ¼ãƒˆï¼ˆåˆ‡æ–­å›æ•°ã‚’æ¸›ã‚‰ã™ãŸã‚ï¼‰
            const sortedParts = [...parts].sort((a, b) => {
                // ã¾ãšé•·ã•ã§é™é †ã‚½ãƒ¼ãƒˆã€æ¬¡ã«å¹…ã§é™é †ã‚½ãƒ¼ãƒˆ
                if (b.length !== a.length) return b.length - a.length;
                return b.width - a.width;
            });
            
            const materials = [];
            
            for (const part of sortedParts) {
                let bestMaterial = null;
                let bestPosition = null;
                let bestScore = -1;
                
                // æ—¢å­˜ã®ææ–™ã«é…ç½®ã‚’è©¦è¡Œï¼ˆæœ€é©ãªä½ç½®ã‚’æ¢ã™ï¼‰
                for (const material of materials) {
                    const position = findOptimalPosition(material, part, material.length, material.width, cuttingMargin);
                    if (position) {
                        // ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼šã‚¨ãƒƒã‚¸åˆ©ç”¨åº¦ã¨ç©ºé–“åŠ¹ç‡ã‚’è€ƒæ…®
                        const score = calculatePlacementScore(material, part, position, material.length, material.width);
                        if (score > bestScore) {
                            bestScore = score;
                            bestMaterial = material;
                            bestPosition = position;
                        }
                    }
                }
                
                if (bestMaterial && bestPosition) {
                    bestMaterial.parts.push({
                        id: part.id,
                        name: part.name,
                        originalName: part.originalName,
                        length: part.length,
                        width: part.width,
                        x: bestPosition.x,
                        y: bestPosition.y
                    });
                } else {
                    // æ–°ã—ã„ææ–™ãŒå¿…è¦ - æœ€é©ãªææ–™ã‚¿ã‚¤ãƒ—ã‚’é¸æŠï¼ˆæšæ•°åˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
                    let bestMaterialType = null;
                    for (const materialType of materialTypes) {
                        if (part.length <= materialType.length && part.width <= materialType.width && 
                            materialType.usedCount < materialType.maxCount) {
                            if (!bestMaterialType || 
                                (materialType.length * materialType.width) < (bestMaterialType.length * bestMaterialType.width)) {
                                bestMaterialType = materialType;
                            }
                        }
                    }
                    
                    if (bestMaterialType) {
                        bestMaterialType.usedCount++;
                        materials.push({
                            id: materials.length + 1,
                            length: bestMaterialType.length,
                            width: bestMaterialType.width,
                            type: bestMaterialType.type,
                            parts: [{
                                id: part.id,
                                name: part.name,
                                originalName: part.originalName,
                                length: part.length,
                                width: part.width,
                                x: 0,
                                y: 0
                            }]
                        });
                    } else {
                        // ææ–™ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã®è­¦å‘Š
                        const unplacedParts = sortedParts.slice(sortedParts.indexOf(part));
                        alert(`ææ–™ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚\né…ç½®ã§ããªã„éƒ¨å“: ${unplacedParts.map(p => p.name).join(', ')}\n\nææ–™ã®æšæ•°ã‚’å¢—ã‚„ã™ã‹ã€éƒ¨å“ã‚’æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚`);
                        break;
                    }
                }
            }

            displayCuttingDiagram(materials, cuttingMargin, materialLength1, materialWidth1, materialCount1, materialLength2, materialWidth2, materialCount2);
        }

        function findOptimalPosition(material, part, materialLength, materialWidth, cuttingMargin) {
            const candidates = [];
            
            // ã‚¨ãƒƒã‚¸ä½ç½®ã‚’å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯ï¼ˆåˆ‡æ–­å›æ•°ã‚’æ¸›ã‚‰ã™ãŸã‚ï¼‰
            const positions = [
                { x: 0, y: 0 }, // å·¦ä¸Šè§’
            ];
            
            // æ—¢å­˜éƒ¨å“ã®å³ç«¯ã¨ä¸‹ç«¯ã«æ²¿ã£ãŸä½ç½®ã‚’è¿½åŠ 
            for (const existing of material.parts) {
                positions.push(
                    { x: existing.x + existing.length + cuttingMargin, y: existing.y }, // å³éš£
                    { x: existing.x, y: existing.y + existing.width + cuttingMargin }, // ä¸‹éš£
                    { x: existing.x + existing.length + cuttingMargin, y: existing.y + existing.width + cuttingMargin } // å³ä¸‹
                );
            }
            
            // ææ–™ã®ç«¯ã«æ²¿ã£ãŸä½ç½®ã‚‚è¿½åŠ 
            for (const existing of material.parts) {
                positions.push(
                    { x: materialLength - part.length, y: existing.y }, // å³ç«¯æƒãˆ
                    { x: existing.x, y: materialWidth - part.width } // ä¸‹ç«¯æƒãˆ
                );
            }
            
            // å„å€™è£œä½ç½®ã‚’ãƒã‚§ãƒƒã‚¯
            for (const pos of positions) {
                if (pos.x >= 0 && pos.y >= 0 && 
                    pos.x + part.length <= materialLength && 
                    pos.y + part.width <= materialWidth &&
                    canPlaceAt(material.parts, pos.x, pos.y, part.length, part.width, cuttingMargin)) {
                    candidates.push(pos);
                }
            }
            
            if (candidates.length === 0) return null;
            
            // æœ€é©ãªä½ç½®ã‚’é¸æŠï¼ˆã‚¨ãƒƒã‚¸åˆ©ç”¨åº¦ãŒé«˜ã„ä½ç½®ã‚’å„ªå…ˆï¼‰
            return candidates.reduce((best, current) => {
                const currentScore = calculatePositionScore(current, part, material, materialLength, materialWidth);
                const bestScore = calculatePositionScore(best, part, material, materialLength, materialWidth);
                return currentScore > bestScore ? current : best;
            });
        }
        
        function calculatePositionScore(position, part, material, materialLength, materialWidth) {
            let score = 0;
            
            // ã‚¨ãƒƒã‚¸åˆ©ç”¨ãƒœãƒ¼ãƒŠã‚¹
            if (position.x === 0) score += 10; // å·¦ç«¯
            if (position.y === 0) score += 10; // ä¸Šç«¯
            if (position.x + part.length === materialLength) score += 10; // å³ç«¯
            if (position.y + part.width === materialWidth) score += 10; // ä¸‹ç«¯
            
            // æ—¢å­˜éƒ¨å“ã¨ã®éš£æ¥ãƒœãƒ¼ãƒŠã‚¹
            for (const existing of material.parts) {
                if (position.x === existing.x + existing.length || 
                    position.x + part.length === existing.x) score += 5; // æ¨ªéš£æ¥
                if (position.y === existing.y + existing.width || 
                    position.y + part.width === existing.y) score += 5; // ç¸¦éš£æ¥
            }
            
            // å·¦ä¸Šå„ªå…ˆï¼ˆåŒã‚¹ã‚³ã‚¢ã®å ´åˆï¼‰
            score -= (position.x + position.y) * 0.01;
            
            return score;
        }
        
        function calculatePlacementScore(material, part, position, materialLength, materialWidth) {
            // é…ç½®å¾Œã®ææ–™ä½¿ç”¨åŠ¹ç‡ã‚’è¨ˆç®—
            const totalArea = materialLength * materialWidth;
            const usedArea = material.parts.reduce((sum, p) => sum + (p.length * p.width), 0) + (part.length * part.width);
            const efficiency = usedArea / totalArea;
            
            // ã‚¨ãƒƒã‚¸åˆ©ç”¨åº¦
            const edgeScore = calculatePositionScore(position, part, material, materialLength, materialWidth);
            
            return efficiency * 100 + edgeScore;
        }

        function canPlaceAt(existingParts, x, y, length, width, cuttingMargin) {
            for (const existing of existingParts) {
                // åˆ‡ã‚Šã—ã‚ã‚’è€ƒæ…®ã—ãŸé‡è¤‡ãƒã‚§ãƒƒã‚¯
                if (!(x >= existing.x + existing.length + cuttingMargin || 
                      x + length + cuttingMargin <= existing.x || 
                      y >= existing.y + existing.width + cuttingMargin || 
                      y + width + cuttingMargin <= existing.y)) {
                    return false;
                }
            }
            return true;
        }

        function displayCuttingDiagram(materials, cuttingMargin, materialLength1, materialWidth1, materialCount1, materialLength2, materialWidth2, materialCount2) {
            const container = document.getElementById('cuttingDiagramContainer');
            
            // å…¨ã¦ã®éƒ¨å“ã‚¿ã‚¤ãƒ—ã‚’åé›†ã—ã¦è‰²ã‚’å‰²ã‚Šå½“ã¦
            const allParts = materials.flatMap(material => material.parts);
            const uniquePartTypes = [...new Set(allParts.map(part => part.originalName))];
            
            // åˆå›ã®ã¿è‰²ã‚’å‰²ã‚Šå½“ã¦
            let colorIndex = 0;
            uniquePartTypes.forEach(partType => {
                if (!partTypeColors[partType]) {
                    partTypeColors[partType] = currentColors[colorIndex % currentColors.length];
                    colorIndex++;
                }
            });
            
            // ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆè¡¨ç¤º
            displayColorPalette(uniquePartTypes);
            
            container.innerHTML = materials.map((material, index) => {
                const scale = Math.min(500 / material.length, 300 / material.width);
                return `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">ææ–™ ${material.id} (ã‚¿ã‚¤ãƒ—${material.type})</h3>
                    <div class="cutting-diagram border-2 border-gray-400 bg-amber-50 relative" 
                         style="width: ${material.length * scale}px; height: ${material.width * scale}px;">
                        ${material.parts.map((part, partIndex) => {
                            const partColor = partTypeColors[part.originalName];
                            return `
                            <div class="absolute border-2 border-gray-600 bg-white bg-opacity-80 flex items-center justify-center text-xs font-medium text-gray-800 overflow-hidden"
                                 style="left: ${part.x * scale}px; 
                                        top: ${part.y * scale}px; 
                                        width: ${part.length * scale}px; 
                                        height: ${part.width * scale}px;
                                        background-color: ${partColor};">
                                <div class="text-center leading-tight">
                                    <div class="font-semibold">${part.name}</div>
                                    <div class="text-xs">${part.length}Ã—${part.width}</div>
                                </div>
                            </div>
                            `;
                        }).join('')}
                        <div class="absolute bottom-1 right-1 text-xs text-gray-600 bg-white px-1 rounded">
                            ${material.length} Ã— ${material.width} mm
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // ä½¿ç”¨ç‡è¨ˆç®—
            const totalMaterialArea = materials.reduce((sum, material) => sum + (material.length * material.width), 0);
            const usedArea = parts.reduce((sum, part) => sum + (part.length * part.width), 0);
            const efficiency = ((usedArea / totalMaterialArea) * 100).toFixed(1);
            
            // ææ–™ã‚¿ã‚¤ãƒ—åˆ¥ã®é›†è¨ˆ
            const materialTypeCounts = {};
            materials.forEach(material => {
                const key = `ã‚¿ã‚¤ãƒ—${material.type}`;
                materialTypeCounts[key] = (materialTypeCounts[key] || 0) + 1;
            });
            
            let materialSummary = `ã‚¿ã‚¤ãƒ—1 (${materialLength1}Ã—${materialWidth1}mm): ${materialTypeCounts['ã‚¿ã‚¤ãƒ—1'] || 0}/${materialCount1}æš`;
            if (materialLength2 && materialWidth2) {
                materialSummary += `<br>ã‚¿ã‚¤ãƒ—2 (${materialLength2}Ã—${materialWidth2}mm): ${materialTypeCounts['ã‚¿ã‚¤ãƒ—2'] || 0}/${materialCount2}æš`;
            }
            
            document.getElementById('materialUsage').innerHTML = `
                <div class="bg-blue-50 p-3 rounded-lg">
                    <div class="text-sm">
                        <div><strong>å¿…è¦ææ–™æ•°:</strong> ${materials.length} æš</div>
                        <div><strong>ä½¿ç”¨çŠ¶æ³:</strong><br>${materialSummary}</div>
                        <div><strong>ææ–™ä½¿ç”¨ç‡:</strong> ${efficiency}%</div>
                        <div><strong>ç·éƒ¨å“æ•°:</strong> ${parts.length} å€‹</div>
                        <div><strong>åˆ‡ã‚Šã—ã‚:</strong> ${cuttingMargin}mm</div>
                    </div>
                </div>
            `;

            // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('saveImageBtn').disabled = false;
        }

        function displayColorPalette(uniquePartTypes) {
            const paletteSection = document.getElementById('colorPaletteSection');
            const palette = document.getElementById('colorPalette');
            
            if (uniquePartTypes.length > 0) {
                paletteSection.classList.remove('hidden');
                
                palette.innerHTML = uniquePartTypes.map(partType => {
                    const currentColor = partTypeColors[partType];
                    return `
                        <div class="flex items-center gap-2 bg-white p-3 rounded-lg border shadow-sm hover:shadow-md transition-shadow">
                            <div class="w-8 h-8 rounded-lg border-2 border-gray-300 cursor-pointer hover:border-blue-400 transition-colors" 
                                 style="background-color: ${currentColor};"
                                 onclick="openColorPicker('${partType}', this)"
                                 title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦è‰²ã‚’å¤‰æ›´"></div>
                            <span class="text-sm font-medium text-gray-700">${partType}</span>
                            <div class="text-xs text-gray-500 ml-auto">${currentColor.toUpperCase()}</div>
                        </div>
                    `;
                }).join('');
            } else {
                paletteSection.classList.add('hidden');
            }
        }

        function openColorPicker(partType, element) {
            const colorPicker = document.createElement('input');
            colorPicker.type = 'color';
            colorPicker.value = partTypeColors[partType];
            colorPicker.style.position = 'absolute';
            colorPicker.style.opacity = '0';
            colorPicker.style.pointerEvents = 'none';
            
            colorPicker.addEventListener('change', function(e) {
                const newColor = e.target.value;
                partTypeColors[partType] = newColor;
                element.style.backgroundColor = newColor;
                
                // ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚‚æ›´æ–°
                const colorCodeElement = element.parentElement.querySelector('.text-xs.text-gray-500');
                if (colorCodeElement) {
                    colorCodeElement.textContent = newColor.toUpperCase();
                }
                
                // æœ¨å–å›³ã‚’å†æç”»
                regenerateDiagram();
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                showColorChangeMessage(partType, newColor);
                
                document.body.removeChild(colorPicker);
            });
            
            document.body.appendChild(colorPicker);
            colorPicker.click();
        }

        function showColorChangeMessage(partName, color) {
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg z-50 shadow-lg';
            message.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded border border-white" style="background-color: ${color};"></div>
                    <span>${partName}ã®è‰²ã‚’å¤‰æ›´ã—ã¾ã—ãŸ</span>
                </div>
            `;
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 2000);
        }

        function regenerateDiagram() {
            generateCuttingDiagram();
        }

        function saveAsImage() {
            const container = document.getElementById('cuttingDiagramContainer');
            const creatorName = document.getElementById('creatorName').value || '';
            
            // html2canvasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
            if (!window.html2canvas) {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = function() {
                    captureAndSave();
                };
                document.head.appendChild(script);
            } else {
                captureAndSave();
            }

            function captureAndSave() {
                // ä¸€æ™‚çš„ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´
                const originalStyle = container.style.cssText;
                container.style.backgroundColor = 'white';
                container.style.border = 'none';
                container.style.borderRadius = '0';
                container.style.padding = '20px';

                // ä½œæˆè€…åã‚’ä¸€æ™‚çš„ã«è¿½åŠ 
                let creatorElement = null;
                if (creatorName) {
                    creatorElement = document.createElement('div');
                    creatorElement.style.position = 'absolute';
                    creatorElement.style.bottom = '10px';
                    creatorElement.style.right = '20px';
                    creatorElement.style.fontSize = '14px';
                    creatorElement.style.fontWeight = 'bold';
                    creatorElement.style.color = '#333';
                    creatorElement.style.backgroundColor = 'rgba(255,255,255,0.8)';
                    creatorElement.style.padding = '4px 8px';
                    creatorElement.style.borderRadius = '4px';
                    creatorElement.textContent = creatorName;
                    container.appendChild(creatorElement);
                }

                html2canvas(container, {
                    backgroundColor: 'white',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    logging: false
                }).then(canvas => {
                    // å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¾©å…ƒ
                    container.style.cssText = originalStyle;
                    
                    // ä½œæˆè€…åè¦ç´ ã‚’å‰Šé™¤
                    if (creatorElement) {
                        container.removeChild(creatorElement);
                    }

                    // JPEGã¨ã—ã¦ä¿å­˜
                    const link = document.createElement('a');
                    link.download = `æœ¨å–å›³_${new Date().toISOString().slice(0, 10)}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                }).catch(error => {
                    console.error('ç”»åƒä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                    // å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¾©å…ƒ
                    container.style.cssText = originalStyle;
                    
                    // ä½œæˆè€…åè¦ç´ ã‚’å‰Šé™¤
                    if (creatorElement) {
                        container.removeChild(creatorElement);
                    }
                    
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã®ä»£æ›¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg z-50';
                    errorDiv.textContent = 'ç”»åƒä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    document.body.appendChild(errorDiv);
                    setTimeout(() => errorDiv.remove(), 3000);
                });
            }
        }

        function exportProject() {
            // ç¾åœ¨ã®ã™ã¹ã¦ã®è¨­å®šã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é›†ç´„
            const projectData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                creatorName: document.getElementById('creatorName').value,
                materialSettings: {
                    material1: {
                        length: parseInt(document.getElementById('materialLength1').value),
                        width: parseInt(document.getElementById('materialWidth1').value),
                        count: parseInt(document.getElementById('materialCount1').value)
                    },
                    material2: {
                        length: document.getElementById('materialLength2').value ? parseInt(document.getElementById('materialLength2').value) : null,
                        width: document.getElementById('materialWidth2').value ? parseInt(document.getElementById('materialWidth2').value) : null,
                        count: parseInt(document.getElementById('materialCount2').value)
                    },
                    cuttingMargin: parseInt(document.getElementById('cuttingMargin').value)
                },
                parts: parts.map(p => ({
                    name: p.name,
                    length: p.length,
                    width: p.width,
                    originalName: p.originalName
                })),
                partTypeColors: partTypeColors
            };

            // JSONã‚’æ–‡å­—åˆ—ã«å¤‰æ›
            const jsonString = JSON.stringify(projectData, null, 2);
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `æœ¨å–å›³ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ_${new Date().toISOString().slice(0, 10)}.woodcut`;
            link.click();
            URL.revokeObjectURL(url);

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            showExportMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function importProject(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const projectData = JSON.parse(e.target.result);
                    
                    // æ¤œè¨¼
                    if (!projectData.parts) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                        return;
                    }

                    // ææ–™è¨­å®šã‚’å¾©å…ƒ
                    document.getElementById('materialLength1').value = projectData.materialSettings.material1.length;
                    document.getElementById('materialWidth1').value = projectData.materialSettings.material1.width;
                    document.getElementById('materialCount1').value = projectData.materialSettings.material1.count;
                    
                    if (projectData.materialSettings.material2.length) {
                        document.getElementById('materialLength2').value = projectData.materialSettings.material2.length;
                        document.getElementById('materialWidth2').value = projectData.materialSettings.material2.width;
                    } else {
                        document.getElementById('materialLength2').value = '';
                        document.getElementById('materialWidth2').value = '';
                    }
                    
                    document.getElementById('materialCount2').value = projectData.materialSettings.material2.count;
                    document.getElementById('cuttingMargin').value = projectData.materialSettings.cuttingMargin;
                    document.getElementById('creatorName').value = projectData.creatorName || '';

                    // éƒ¨å“ã‚’å¾©å…ƒ
                    parts = [];
                    partIdCounter = 1;
                    projectData.parts.forEach(p => {
                        parts.push({
                            id: partIdCounter++,
                            name: p.name,
                            length: p.length,
                            width: p.width,
                            originalName: p.originalName,
                            placed: false
                        });
                    });

                    // è‰²è¨­å®šã‚’å¾©å…ƒ
                    partTypeColors = projectData.partTypeColors || {};

                    // UIã‚’æ›´æ–°
                    updatePartsList();

                    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    showExportMessage('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹ãã¾ã—ãŸ');
                } catch (error) {
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);

            // ã‚¤ãƒ³ãƒãƒƒãƒˆå…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
            event.target.value = '';
        }

        function showExportMessage(text) {
            const message = document.createElement('div');
            message.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg z-50 shadow-lg';
            message.textContent = text;
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 2000);
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
        document.addEventListener('DOMContentLoaded', function() {
            // ã‚µãƒ³ãƒ—ãƒ«éƒ¨å“ã‚’è¿½åŠ 
            parts = [
                { id: 1, name: 'å´æ¿', length: 280, width: 160, originalName: 'å´æ¿', placed: false },
                { id: 2, name: 'å´æ¿', length: 280, width: 160, originalName: 'å´æ¿', placed: false },
                { id: 3, name: 'ä¸­æ¿', length: 248, width: 160, originalName: 'ä¸­æ¿', placed: false },
                { id: 4, name: 'åº•æ¿', length: 340, width: 160, originalName: 'åº•æ¿', placed: false }
            ];
            partIdCounter = 5;
            updatePartsList();
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9cc37c2ab4861ec9',t:'MTc3MDgwOTEyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
